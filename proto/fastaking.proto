// proto/fastaking.v1.proto
syntax = "proto3";

// Using the 'fastaking' package name as requested to avoid underscores
package fastaking;

import "google/protobuf/empty.proto";

service FaStaking {
  rpc GetStakingHistory(ActivityRequest) returns (ActivityResponse);
  rpc GetUnstakingHistory(ActivityRequest) returns (ActivityResponse);
  rpc GetClaimHistory(ActivityRequest) returns (ActivityResponse);
  rpc GetAllHistory(ActivityRequest) returns (ActivityResponse);
  // (FR-1) Logs a new staking or unstaking event.
  rpc LogStakingActivity (LogStakingActivityRequest) returns (google.protobuf.Empty);

  rpc GetRewardConfig(google.protobuf.Empty) returns (RewardConfigResponse);
  rpc ClaimRewards(ClaimRequest) returns (ClaimResponse);

  rpc GetUserInfo(UserInfoRequest) returns (UserInfoResponse);
  rpc GetAdminUserInfo(GetAdminUserInfoRequest) returns (GetAdminUserInfoResponse);
  
  // (NFR-2) Standard liveness/readiness check.
  // This is a simple, explicit check. 
  // We will *also* implement the gRPC Health Checking Protocol (tonic_health)
  // for Kubernetes probes, as discussed earlier.
  rpc CheckHealth (google.protobuf.Empty) returns (HealthCheckResponse);
}

//================================================================
// Message Definitions
//================================================================
message ActivityRequest {
  string walletAddress = 1;
  uint32 page = 2;
  uint32 limit = 3;
}

message ActivityResponse {
  repeated ActivityEvent data = 1;
  uint32 total = 2;
  uint32 page = 3;
  uint32 totalPages = 4;
  bool hasNextPage = 5;
}

message ActivityEvent {
  string digest = 1;
  string timestamp = 2;
  string eventType = 3;
  string objectId = 4;
  uint32 tokenId = 5;
  string rewardAmount = 6;
}

// --- Enum for Staking Action ---
enum StakingAction {
  UNSPECIFIED = 0;
  STAKING = 1;
  UNSTAKING = 2;
}

// --- Messages for LogStakingActivity (FR-1) ---
message LogStakingActivityRequest {
  string user_id = 1; // web_user.auth_user.id (UUID)
  uint32 nft_id = 2; // u16 validation will be done in the service logic
  StakingAction action = 3;
  string transaction_digest = 4; // SUI transaction digest
  string sui_address = 5;
}

// Helper message for nested reward structures
message GradeReward {
  uint32 Common = 1;
  uint32 Uncommon = 2;
  uint32 Rare = 3;
  uint32 Epic = 4;
  uint32 First = 5;
}

// The main reward configuration structure
message RewardTable {
  uint32 MaxStakableCount = 1;
  uint32 GradeBoostMax = 2;
  uint32 WeeklyClaimBoost = 3;
  uint32 EventBoost = 4;
  
  // JSON in DB, parsed into array for gRPC
  repeated uint32 ClaimTargets = 5; 
  
  GradeReward DefaultReward = 6;
  GradeReward GradeBoostReward = 7;
  
  // JSON in DB, parsed into array for gRPC
  repeated uint32 StakeCountBoost = 8;

  // We also include these fields from the DB, as they might be useful
  // (Even if the original TS proto didn't show them)
  string id = 9; // u64
  string expire_date = 10; // Timestamp
}

message RewardConfigResponse {
  RewardTable rewardTable = 1;
}

// --- Messages for CheckHealth (NFR-2) ---
message HealthCheckResponse {
  string status = 1; // e.g., "SERVING"
}

message ClaimRequest {
  string walletAddress = 1;
}

message ClaimResponse {
  bool success = 1;
  string message = 2;
  string amount = 3;
}

message GradeBreakdown {
  uint32 first = 1;
  uint32 epic = 2;
  uint32 rare = 3;
  uint32 uncommon = 4;
}

message Boost {
  double stakeCount = 1;
  double grade = 2;
  double weekly = 3;
  double event = 4;
}

message RewardDetail {
  GradeBreakdown default = 1;
  Boost boost = 2;
}

message UserInfoRequest {
  string walletAddress = 1;
}

message UserInfoResponse {
  double accumulated = 1;
  double claimable = 2;
  double total = 3;
  double rewardBase = 4;
  uint32 staked = 5;
  uint32 nft = 6;
  double tokenBalance = 7;
  uint32 activeCount = 8;
  double thisWeekStakingBoost = 9;
  double thisWeekGradeBoost = 10;
  RewardDetail rewardDetail = 11;
}

message GetAdminUserInfoRequest {
  string walletAddress = 1; 
}

message AdminStakeInfo {
  string nft_id = 1;
  uint64 token_id = 2;
  uint64 stake_timestamp_ms = 3;
  string grade = 4;
}

message AdminTimelineInterval {
  uint64 token_id = 1;
  uint64 start_ms = 2;
  uint64 end_ms = 3; // 0 if active
  string grade = 4;
  bool is_effective = 5;
}

message AdminWeeklyReward {
  string week_start_date = 1;
  uint64 reward_amount = 2;
  repeated uint64 counted_token_ids = 3;
}

message GetAdminUserInfoResponse {
  string wallet_address = 1;
  uint64 user_id = 2; 

  repeated AdminStakeInfo current_stakes = 3;
  repeated AdminTimelineInterval timeline = 4;
  
  uint64 total_reward = 5;
  repeated AdminWeeklyReward weekly_rewards = 6;
}